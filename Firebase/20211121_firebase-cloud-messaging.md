## Firebase Cloud Messaging (FCM) 소개



## 푸시 알림 흐름

<img src="https://user-images.githubusercontent.com/71204049/142550883-6779de06-9d89-4141-9517-7572a8577746.png" width="700" />

(사진 출처: [dev.to](https://dev.to/jakubkoci/react-native-push-notifications-313i))



흐름을 요약하자면 아래와 같다.

1. FCM에 앱을 등록하고, 앱도 FCM과 연동한다.

2. 앱 프론트는 필요할 때 FCM 토큰을 발급받고 백엔드로 보낸다.

3. 백엔드는 토큰을 유저 정보와 연동하여 DB에 보관하다가, 필요할 때 조회해서 Notification Provider에 푸시 알림을 요청한다.



- 여기서 FCM 토큰이란?
  - 푸시 알림을 보낼 디바이스들을 식별하기 위해 존재한다.
- 각각의 디바이스에 어떻게 개별적으로 푸시 알림을 보낼까?
  - FCM 토큰으로 디바이스를 구분한다. 디바이스마다 별도의 FCM 토큰이 존재한다. 따라서 DB의 유저 테이블에 FCM 토큰 필드를 추가하고,  푸시 알람을 줄 때 유저의 토큰 필드를 조회하여 보내는 식이다.





## FCM 토큰 생성 및 삭제

### 토큰의 생성

앱을 처음 실행할 때 FCM SDK는 클라이언트 앱 인스턴스에 대한 등록 토큰을 생성한다.

### 토큰의 만료(Expire)

FCM 토큰은 정해진 수명이나 갱신 주기가 없다.

따라서, 시간과 관계없이 아래 이벤트가 발생하지 않는다면 만료되지 않는다.

- 앱이 인스턴스 ID를 삭제한 경우
- 앱이 새 기기에서 복원되었을 경우
- 사용자가 앱을 제거 / 재설치한 경우
- 사용자가 앱 데이터를 지운 경우

### 토큰의 갱신(Refresh)

onTokenRefresh() 메서드는 토큰이 갱신될 때마다 호출된다.

갱신될 때마다 동작해야하는 로직이 있다면, 해당 메소드를 오버라이딩하여 구현한다.



## 토큰 관리

#### 기본 관행

- 서버에 등록 토큰을 저장한다.
  - 서버의 주요 역할은 각 클라이언트의 토큰을 추적하고 활성 토큰의 업데이트된 목록을 유지하는 것이다.
  - 따라서, 토큰 타임스탬프를 구현하고 이 타임스탬프를 정기적으로 업데이트할 필요가 있다.
- 토큰의 Refreshness(신선도) 보장
  - 오래된 등록 토큰을 제거한다.
    - 



- 토큰을 언제 서버에 보낼까?
  - 로그인 시점에 보낸다.
  - 앱을 띄우는 순간 보낸다.
- 토큰은 언제 삭제할까?
  - Provider가 Notification Server로 푸시 요청을 했을 때, 토큰이 만료되어 에러 메시지가 오는 경우, 핸들링하여 그 토큰을 삭제한다.



- 보통 서버에서 토큰을 관리
  - DB의 유저 테이블에 FCM 토큰 필드를 추가
  - 로그인 시 서버에 유저 토큰을 저장
  - 푸시 알림을 보낼 때 이를 조회하여 Notification Server에 요청한다.
- - 
  - 별도의 유저 관리 서버를 가지고 있다면, 토큰이 업데이트 됨에 따라 토큰 필드도 업데이트 되어야 한다. 즉, 디바이스에서 일정 주기마다 혹은 앱 실행시마다 토큰 갱신 여부를 확인하고 이를 서버에 등록해주는 과정이 필요하다.





## FCM을 사용한 아이폰 PUSH 알람 기능 이용하기

- FCM에 앱을 인증하는 방법 두 가지
  - 인증서
  - 인증키(권장)

- - 



## 고려해야할 부분

- 같은 기기에서 다른 아이디를 쓰는 경우
  - 로그아웃 시점에 서버에서 유저 토큰을 삭제한다.

- 같은 아이디로 여러 기기를 쓰는 경우
  - 하나의 유저가 여러 토큰을 보유할 수 있게 스키마를 구성한다.



## 프론트엔드에서 해야할 것

1. FCM에 앱 등록

2. 앱에 FCM 연동

3. 앱 실행 시 토큰 발급 (자동)

4. 서버에 로그인 요청할 때 FCM 토큰 전송

5. 서버에 로그아웃 요청할 때 FCM 토큰 전송
6. 푸시 알림을 끄길 원할 때 FCM 토큰 전송 



## 백엔드에서 해야할 것

1. 로그인 시 유저의 FCM 토큰 저장
2. 로그아웃 시 유저의 FCM 토큰 삭제
3. 푸시 알림을 끌 때 유저의 FCM 토큰 삭제
4. Notification Server에 푸시 알림 요청
5. 요청했는데 토큰이 만료되었다는 에러 메시지를 수신할 경우 해당 유저의 토큰 삭제 
